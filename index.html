<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpha - Chatbot de Tecnologia</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container { max-width: 800px; }
        .card { border-radius: 15px; border: none; }
        .card-header { border-radius: 15px 15px 0 0 !important; }
        .card-footer { border-radius: 0 0 15px 15px !important; background-color: white; }
        #chat-messages { background-color: #f8f9fa; padding: 1rem; }
        .message { margin-bottom: 1rem; animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-content {
            display: inline-block;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .bot-message .message-content {
            background-color: #e7f3ff;
            border: 1px solid #b8daff;
        }
        .user-message { text-align: right; }
        .user-message .message-content {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
        }
        #user-input { border-radius: 25px; padding: 0.75rem 1.25rem; }
        #send-btn { border-radius: 25px; padding: 0.75rem 1.5rem; }
        @media (max-width: 768px) {
            #chat-messages { height: 400px !important; }
            .message-content { max-width: 90%; }
        }
        .api-key-banner {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
        }
        .api-key-input {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <!-- Banner de configura√ß√£o da API Key -->
        <div id="api-key-banner" class="api-key-banner">
            <h6><i class="bi bi-info-circle"></i> Configure sua API Key do Gemini</h6>
            <p class="mb-2 small">
                Obtenha gratuitamente em: 
                <a href="https://aistudio.google.com/app/apikey" target="_blank">https://aistudio.google.com/app/apikey</a>
            </p>
            <div class="api-key-input">
                <input type="text" id="api-key-input" class="form-control" placeholder="Cole sua API Key aqui (ex: AIzaSy...)">
                <button class="btn btn-warning" onclick="saveApiKey()">Salvar</button>
            </div>
        </div>

        <div class="text-center mb-4">
            <h1 class="fw-bold text-primary">ü§ñ Alpha</h1>
            <p class="text-muted">Assistente inteligente de tecnologia - Alpha Insights</p>
        </div>
        
        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span>üí¨ Conversa com Alpha</span>
                
                <div class="dropdown">
                    <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <label class="dropdown-item" for="file-upload" style="cursor: pointer;">
                                <i class="bi bi-upload"></i> Upload Planilha CSV
                            </label>
                            <input type="file" id="file-upload" accept=".csv" style="display: none;">
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" href="#" onclick="showApiKeyBanner()">
                                <i class="bi bi-key"></i> Configurar API Key
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item text-danger" href="#" id="clear-chat">
                                <i class="bi bi-trash"></i> Limpar conversa
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="card-body" id="chat-messages" style="height: 500px; overflow-y: auto;">
                <div class="message bot-message">
                    <div class="message-content">
                        <strong>Alpha:</strong> Ol√°! Sou o Alpha, seu assistente especializado em tecnologia. 
                        Posso ajud√°-lo com informa√ß√µes sobre produtos eletr√¥nicos, hardware, software e an√°lise de dados. 
                        Configure sua API Key do Gemini acima para come√ßar! üìä
                    </div>
                </div>
            </div>
            
            <div class="card-footer">
                <div class="input-group">
                    <input type="text" id="user-input" class="form-control" placeholder="Digite sua mensagem...">
                    <button class="btn btn-primary" id="send-btn">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
                <div id="typing-indicator" class="text-muted small mt-2" style="display: none;">
                    <i class="bi bi-three-dots"></i> Alpha est√° digitando...
                </div>
            </div>
        </div>
        
        <div class="text-center mt-3 text-white small">
            Desenvolvido com ‚ù§Ô∏è por Alpha Insights | Powered by Google Gemini
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <script>
        // Vari√°veis globais
        let geminiApiKey = localStorage.getItem('geminiApiKey') || '';
        let csvData = null;
        
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const typingIndicator = document.getElementById('typing-indicator');
        const fileUpload = document.getElementById('file-upload');
        const clearChat = document.getElementById('clear-chat');
        const apiKeyBanner = document.getElementById('api-key-banner');
        
        // Verificar se j√° tem API Key salva
        if (geminiApiKey) {
            apiKeyBanner.style.display = 'none';
        }
        
        // Salvar API Key
        function saveApiKey() {
            const key = document.getElementById('api-key-input').value.trim();
            if (!key) {
                alert('Por favor, insira uma API Key v√°lida!');
                return;
            }
            if (!key.startsWith('AIza')) {
                alert('API Key inv√°lida! Deve come√ßar com "AIza"');
                return;
            }
            geminiApiKey = key;
            localStorage.setItem('geminiApiKey', key);
            apiKeyBanner.style.display = 'none';
            addMessage('‚úÖ API Key configurada com sucesso! Agora voc√™ pode conversar comigo.', 'bot');
        }
        
        function showApiKeyBanner() {
            apiKeyBanner.style.display = 'block';
            document.getElementById('api-key-input').value = geminiApiKey;
            return false;
        }
        
        // Enviar mensagem
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            
            if (!geminiApiKey) {
                alert('Configure sua API Key do Gemini primeiro!');
                showApiKeyBanner();
                return;
            }
            
            addMessage(message, 'user');
            userInput.value = '';
            typingIndicator.style.display = 'block';
            
            try {
                const response = await callGeminiAPI(message);
                addMessage(response, 'bot');
            } catch (error) {
                addMessage('Erro ao processar mensagem: ' + error.message, 'bot');
            } finally {
                typingIndicator.style.display = 'none';
            }
        }
        
        // Chamar Gemini API
        async function callGeminiAPI(userMessage) {
            const systemPrompt = `Voc√™ √© o Alpha, assistente virtual especializado em tecnologia da empresa Alpha Insights.

REGRAS IMPORTANTES:
1. Responda APENAS perguntas sobre: tecnologia, eletr√¥nicos, computadores, smartphones, hardware, software, gadgets, an√°lise de dados, programa√ß√£o, IA, internet, redes.

2. Se a pergunta N√ÉO for sobre tecnologia (comida, receitas, hist√≥ria geral, pol√≠tica, medicina), responda EXATAMENTE:
"Desculpe, sou especializado apenas em quest√µes relacionadas a tecnologia e varejo tech. Como posso ajud√°-lo com produtos eletr√¥nicos, an√°lise de dados ou informa√ß√µes sobre tecnologia?"

3. Seja profissional, claro e objetivo.
4. Use formata√ß√£o markdown quando apropriado (negrito com **, it√°lico com *).`;
            
            let fullPrompt = systemPrompt + '\n\nPERGUNTA DO USU√ÅRIO:\n' + userMessage;
            
            // Adicionar contexto da planilha se existir
            if (csvData) {
                const headers = csvData[0].join(', ');
                const sampleRows = csvData.slice(1, 11).map((row, i) => 
                    `Linha ${i+1}: ${row.join(' | ')}`
                ).join('\n');
                
                fullPrompt += `\n\nCONTEXTO DA PLANILHA CSV:
Total de linhas: ${csvData.length - 1}
Colunas: ${headers}

Amostra dos dados (primeiras 10 linhas):
${sampleRows}

Analise esses dados e responda a pergunta do usu√°rio com base neles.`;
            }
            
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiApiKey}`;
            
            const requestBody = {
                contents: [{
                    parts: [{ text: fullPrompt }]
                }],
                generationConfig: {
                    temperature: 0.7,
                    maxOutputTokens: 1024
                }
            };
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                if (response.status === 400) {
                    throw new Error('API Key inv√°lida ou expirada. Configure uma nova no menu!');
                }
                throw new Error(`Erro HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.candidates && data.candidates[0]?.content?.parts[0]?.text) {
                let text = data.candidates[0].content.parts[0].text;
                // Converter markdown b√°sico para HTML
                text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
                text = text.replace(/\n/g, '<br>');
                return text;
            }
            
            return 'Desculpe, n√£o consegui processar sua pergunta. Tente novamente.';
        }
        
        // Adicionar mensagem ao chat
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            const content = document.createElement('div');
            content.className = 'message-content';
            content.innerHTML = `<strong>${sender === 'user' ? 'Voc√™' : 'Alpha'}:</strong> ${text}`;
            
            messageDiv.appendChild(content);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Upload de CSV
        fileUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.csv')) {
                alert('Apenas arquivos CSV s√£o aceitos!');
                fileUpload.value = '';
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                alert('Arquivo muito grande! M√°ximo: 5MB');
                fileUpload.value = '';
                return;
            }
            
            addMessage('üìÇ Processando planilha...', 'bot');
            
            Papa.parse(file, {
                complete: function(results) {
                    csvData = results.data.filter(row => row.some(cell => cell.trim() !== ''));
                    
                    if (csvData.length > 0) {
                        addMessage(`‚úÖ Planilha carregada com sucesso! Cont√©m ${csvData.length - 1} linhas e ${csvData[0].length} colunas. Fa√ßa perguntas sobre os dados!`, 'bot');
                    } else {
                        addMessage('‚ùå Erro ao ler CSV. Verifique o formato do arquivo.', 'bot');
                        csvData = null;
                    }
                },
                error: function(error) {
                    addMessage('‚ùå Erro ao processar CSV: ' + error.message, 'bot');
                    csvData = null;
                }
            });
            
            fileUpload.value = '';
        });
        
        // Limpar chat
        clearChat.addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('Deseja limpar a conversa?')) {
                chatMessages.innerHTML = '';
                csvData = null;
                addMessage('Conversa limpa! Como posso ajud√°-lo?', 'bot');
            }
        });
    </script>
</body>
</html>
